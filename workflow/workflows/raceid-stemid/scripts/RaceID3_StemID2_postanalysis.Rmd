---
title: "RaceId2/StemID Post-Analysis"
author: "Jasper Koning & Michael de Kok"
---

```{r Setup, include=FALSE}

## Load Sources and install required Packages, but only if needed
if (!"devtools" %in% installed.packages()) install.packages("devtools")
library(devtools)
install_github("dgrun/RaceID3_StemID2_package")
library(RaceID)

```


## Highlight transcirpt counts of a set of genes in t-SNE map

```{r Genes, include=TRUE}

g <- c("Apoa1__chr9", "Apoa1bp__chr3", "Apoa2__chr1", "Apoa4__chr9", "Apoa5__chr9")
plotexptsne(sc,g,n="Apoa genes",logsc=TRUE)

```



## Analysis of Differentially expressed genes between two sets of clusters

```{r DiffClusters, include=TRUE}
cdiff <- clustdiffgenes(sc,4,pvalue=.01)
d <- diffgenes(sc,cl1=3,cl2=c(2,11),mincount=1)
plotdiffgenes(d,gene=names(d$z)[1])

```


# differentially expressed genes between two sets of cells, e. g. cluster 3 and clusters 2,11 by a different approach based on the overlap of transctipt count distributions

```{r DiffCells, include=TRUE}

A <- names(sc@cpart)[sc@cpart %in% c(2,4)]
B <- names(sc@cpart)[sc@cpart %in% c(3)]
x <- diffexpnb(getfdata(sc,n=c(A,B)), A=A, B=B )
plotdiffgenesnb(x,pthr=.05,lthr=.5,mthr=-1,Aname="Cl.2",Bname="Cl.3,5",show_names=TRUE,padj=TRUE)

```

## Analysis of Specific Clusters

```{r ClusterAnalysis, include=TRUE}

## extract projections onto all links for all cells in a given cluster i
x <- getproj(ltr,i=3)

## heatmap of all projections for cluster i
pheatmap(x$pr)

## heatmap of z-score for all projections for cluster i
pheatmap(x$prz)

```



## Analysis of Branch Cells 

```{r BranchCells, include=TRUE}

## extracting all cells on two branches sharing the same cluster and computing differentially expressed genes between these two branches
x <- branchcells(ltr,list("3.7","2.3"))

## z-scores for differentially expressed genes
head(x$diffgenes$z)

## plotting the cells on the two branches as additional clusters in the t-SNE map
plotmap(x$scl)
# t-SNE map of the clusters with more than cthr cells including a minimum spanning tree for the cluster medoids

# retrieve cells from branch in pseudo-temporal order as inferred by the projection coordinates
n <- cellsfromtree(ltr,c(3,2,11,4))

```



## Identiyfing Cells for Removal

```{r CellsToRemove}

# Set up List for Cells to Remove
CellsToRemove <- list()

#  Manually Add Cell Names to Remove:
NewCellsToRemove <- c("CELLID1", "CELLID2")
CellsToRemove <- c(CellsToRemove, NewCellsToRemove)

# Remove cells currently belonging to a specific cluster: 
Cluster <- 1
NewCellsToRemove <- names(sc@cpart[sc@cpart == Cluster])
CellsToRemove <- c(CellsToRemove, NewCellsToRemove)


# Set up List for Genes to Remove
GenesToRemove <- list()

#  Manually Add Cell Names to Remove:
NewGenesToRemove <- c("0610005C13Rik", "test")
GenesToRemove <- c(GenesToRemove, NewGenesToRemove)

```
