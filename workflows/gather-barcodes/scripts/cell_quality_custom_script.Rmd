---
title: "Cell quality"
author: "Douwe Molenaar"
date: "8/29/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r}
library(rrdm) # Ask Douwe Molenaar (d.molenaar@vu.nl) for a copy of the rdmtool package
library(readr)
library(tidyr)
library(dplyr)
# rdm <- RDMfolder()
# codecount_dir <- 'codecounts'
# 
# annotations <- read_tsv(file_path(rdm, 'aimms.labs.vu.nl',
#                                     'research-sbi-mouse-lymph-node-stromal-cell-time-series/annotations_2018_Aug',
#                                     'annotations.csv'))
# barcodes <- read_tsv(file_path(rdm, 'aimms.labs.vu.nl',
#                                'research-sbi-mouse-lymph-node-stromal-cell-time-series/annotations_common',
#                                'celseq_barcodes.192.txt'),
#                      col_names = c('codenr', 'cellcode'))
# 
# R1fp <- annotations %>% filter(pairEnd==1)
# R1fp <- R1fp$filePrefix
# 
# count_colnames <- c('cellcode', 'umicode', 'reads')
# 
# all_counts <- bind_rows(
#   lapply(R1fp, function(fp) {
#     countfile_path <- file.path(codecount_dir, paste0(fp, '.txt'))
#     counts <- read_tsv(countfile_path, col_names = count_colnames)
#     counts <- counts %>%
#       mutate(filePrefix = fp)
#     return(counts)
#   })
# )

con <- DBI::dbConnect(RPostgreSQL::PostgreSQL(),
                      host = 'localhost',
                      dbname = 'scRNA_Aug2018',
                      user = 'douwe',
                      password = 'molenaar')

# con <- DBI::dbConnect(RMySQL::MySQL(),
#                       host = 'localhost',
#                       dbname = 'scRNAaug2018',
#                       user = 'douwe',
#                       password = 'molenaar')

all_counts <- tbl(con, 'counts')
annotations <- tbl(con, 'annotations')
barcodes <- tbl(con, 'barcodes')

# all_counts <- all_counts %>% 
#   left_join(annotations %>% 
#   select(filePrefix, experiment, time)) %>%
#   left_join(barcodes)

total_reads_per_file <- all_counts %>%
  group_by(filePrefix) %>%
  summarise(totalReads = sum(reads, na.rm=TRUE))

assigned_reads_per_file <- all_counts %>%
  filter(!is.na(codenr)) %>%
  group_by(filePrefix) %>%
  summarise(totalAssignedReads = sum(reads, na.rm = TRUE))

res <- RPostgreSQL::dbSendQuery(con, 
'SELECT total_reads."filePrefix", totalreads, assignedreads, hqcells, experiment, "time", "plate", "sample"
FROM (
	SELECT "filePrefix", sum(reads) AS totalreads
	FROM counts group by "filePrefix") AS total_reads join (
		SELECT "filePrefix", sum(reads) AS assignedreads
		FROM counts JOIN barcodes USING (cellcode)
		GROUP BY "filePrefix"
	) AS assigned_reads USING ("filePrefix")
LEFT JOIN (
	SELECT "filePrefix", count(distinct(cellcode)) AS hqcells
	FROM (
		SELECT "filePrefix", cellcode, SUM(reads) AS readspercell
		FROM counts JOIN barcodes USING (cellcode)
		GROUP BY ("filePrefix", cellcode)
		HAVING SUM(reads) > 1000
	) AS A1
GROUP BY "filePrefix") AS hq_cells USING ("filePrefix")
JOIN annotations USING ("filePrefix")
')

summary_per_file <- RPostgreSQL::fetch(res, n=-1)
summary_per_file <- as_tibble(summary_per_file) %>%
  mutate(assignedPercentage = 100*assignedreads/totalreads)
```

The following table summarizes per sequence file:

* **totalreads**: The total number of reads in the file
* **assignedreads**: The total number of reads with an exact match to a cell barcode
* **hqcells**: The number of 'high quality' cells (those having at least 1000 reads)
* **experiment**: The pilot or time series experiment
* **time**: The time in weeks after birth at which the sample was taken
* **plate**: The plate nr on which the cells were sorted
* **sample**: the sample nr from which the cells originated
* **assignedPercentage**: percentage of reads assigned to cells

Notice that files with low numbers of sequences are in sample nr 11 (4/5), 3 and 7 (2/4). Is that a coincidence? 

```{r}
knitr::kable(summary_per_file, digits=1)
```

```{r}
umi_per_cell <- all_counts %>%
  filter(!is.na(codenr)) %>%
  group_by(filePrefix, codenr, umicode) %>%
  distinct() %>%
  group_by(filePrefix, codenr) %>%
  summarise(nrOfUmi = n()) %>%
  left_join(annotations) %>%
  collect()
```

## number of UMI per cell
The histogram below shows the distribution of the number of UMI's per cell for cells that have at least 1000 reads, i.e. the **hqcells**. The peak around 4000 is caused by the fact that the maximal distinguishable UMI codes is 4^6 = 4096. Additional apparent UMI are casued by unknown ('N') nucleotides in the UMI barcodes.

```{r}
reads_per_cell <- all_counts %>%
  filter(!is.na(codenr)) %>%
  group_by(filePrefix, codenr) %>%
  summarise(readsPerCell = sum(reads, na.rm=TRUE)) %>%
  collect()

reads_and_umi_per_cell <- reads_per_cell %>%
  left_join(umi_per_cell) %>%
  mutate(UMIperRead = nrOfUmi/readsPerCell)

library(ggplot2)
p <- ggplot(reads_and_umi_per_cell %>% filter(readsPerCell>1000), aes(x = nrOfUmi)) + geom_histogram() + 
  labs(x = 'Number of UMI', y= 'Number of cells')
print(p)
```

## reads per cell
The number of reads per cell follows an exponential distribution, as shown below (notice that the y-axis has a logarithmic scale)
```{r}
p <- ggplot(reads_and_umi_per_cell, aes(x=readsPerCell)) + geom_histogram() + scale_y_log10()
print(p)
```


## Saturation
What happens if the number of reads is too low to cover all mRNA molecules in a cell? Then the number of reads per UMI will be close to 1 or lower than 1.
```{r}
p <- ggplot(reads_and_umi_per_cell, aes(x=readsPerCell, y=nrOfUmi, colour=UMIperRead)) + 
  geom_point(size=0.1) + scale_colour_gradient(low='black', high='red') +
  scale_x_log10() + scale_y_log10()
print(p)
```



